<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GoldRates Admin</title>
<link rel="icon" href="assets/favicon.png" />
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<!-- Keep API target same as before; change here if needed -->
<meta name="gold-api" content="https://goldrate-cms.onrender.com" />
<style>
  html,body{height:100%}
  .page{min-height:100%;display:flex;flex-direction:column}
  footer{margin-top:auto}
</style>
</head>
<body class="bg-gray-50 text-gray-900">
<div class="page">
  <div class="max-w-7xl mx-auto p-6 w-full">
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">GOLDRATES.COM ADMIN</h1>
      <div class="flex items-center gap-3">
        <img src="assets/admin-login.png" alt="Admin" class="h-10 w-10 rounded-full ring-2 ring-gray-200 object-cover" onerror="this.src='assets/favicon.png'">
        <button id="logoutBtn" class="text-sm px-3 py-1.5 rounded-lg bg-gray-900 text-white">Logout</button>
      </div>
    </div>

    <!-- LOGIN (visible when no token) -->
    <div id="loginCard" class="max-w-md mt-6 bg-white border rounded-2xl p-6 hidden">
      <div class="flex items-center gap-3 mb-4">
        <img src="assets/admin-login.png" class="h-10 w-10 rounded-full" onerror="this.src='assets/favicon.png'">
        <h2 class="text-lg font-semibold">Admin Sign In</h2>
      </div>
      <div class="space-y-3">
        <input id="loginEmail" type="email" class="w-full border rounded-lg px-3 py-2" placeholder="Email">
        <input id="loginPassword" type="password" class="w-full border rounded-lg px-3 py-2" placeholder="Password">
        <button id="loginBtn" class="w-full bg-amber-500 text-white rounded-lg py-2 font-medium">Sign In</button>
      </div>
    </div>

    <!-- BLOG/NEWS FORM -->
    <section class="mt-6 bg-white border rounded-2xl p-6" id="postFormSection">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Create Post (News/Blog)</h2>
        <label class="inline-flex items-center gap-2 text-sm">
          <input id="p-published" type="checkbox" class="h-4 w-4">
          <span>Publish now</span>
        </label>
      </div>
      <div class="grid sm:grid-cols-2 gap-4 mb-4">
        <select id="p-type" class="border rounded-lg px-3 py-2">
          <option value="news">News</option>
          <option value="blog">Blog</option>
        </select>
        <input id="p-title" class="border rounded-lg px-3 py-2" placeholder="Title" />
      </div>
      <input id="p-excerpt" class="w-full border rounded-lg px-3 py-2 mb-3" placeholder="Short excerpt" />
      <div class="mb-3">
        <div class="text-sm text-gray-600 mb-1">Content</div>
        <div id="quill" class="bg-white rounded-lg border"></div>
      </div>
      <div class="grid sm:grid-cols-2 gap-4 mb-4">
        <div>
          <div class="text-sm text-gray-600 mb-1">Cover Image (Upload)</div>
          <input id="p-image-file" type="file" accept="image/*" class="w-full text-sm" />
        </div>
        <div>
          <div id="imgPreview" class="aspect-video border rounded-lg bg-gray-50 flex items-center justify-center text-xs text-gray-400">Preview</div>
        </div>
      </div>
      <button id="savePost" class="bg-green-600 text-white rounded-lg px-4 py-2 font-medium">Save Post</button>
      <p class="text-xs text-gray-500 mt-2">If “Publish now” is not ticked, the post will be saved as <b>Draft</b>.</p>
    </section>

    <!-- USER CREATION (FIRST BELOW BLOG FORM) -->
    <section class="mt-6 bg-white border rounded-2xl p-6" id="userCreateSection">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Create User</h2>
      </div>
      <div class="grid sm:grid-cols-3 gap-3">
        <input id="u-name" class="border rounded-lg px-3 py-2" placeholder="Name">
        <input id="u-email" type="email" class="border rounded-lg px-3 py-2" placeholder="Email">
        <input id="u-password" type="text" class="border rounded-lg px-3 py-2" placeholder="Password">
      </div>
      <div class="mt-3">
        <button id="createUser" class="bg-blue-600 text-white rounded-lg px-4 py-2">Create User</button>
      </div>
    </section>

    <!-- POSTS TABLE -->
    <section class="mt-6 bg-white border rounded-2xl p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Posts</h2>
        <button id="refreshPosts" class="text-sm px-3 py-1.5 rounded-lg border">Refresh</button>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead><tr class="text-left border-b">
            <th class="py-2 pr-3">Title</th>
            <th class="py-2 pr-3">Type</th>
            <th class="py-2 pr-3">Status</th>
            <th class="py-2 pr-3">Created</th>
          </tr></thead>
          <tbody id="postsTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- USERS TABLE (optional, keeps parity with your old page) -->
    <section class="mt-6 bg-white border rounded-2xl p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Users</h2>
        <button id="refreshUsers" class="text-sm px-3 py-1.5 rounded-lg border">Refresh</button>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead><tr class="text-left border-b">
            <th class="py-2 pr-3">Name</th>
            <th class="py-2 pr-3">Email</th>
            <th class="py-2 pr-3">Role</th>
            <th class="py-2 pr-3">Created</th>
          </tr></thead>
          <tbody id="usersTbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Sticky footer as requested -->
  <footer class="bg-white border-t">
    <div class="max-w-7xl mx-auto px-6 py-4 text-xs text-gray-600 flex items-center justify-between">
      <span>© goldrates.com</span>
      <span>design and development by <a class="underline" href="https://tecnavis.in" target="_blank" rel="noopener">tecnavis.in</a></span>
    </div>
  </footer>
</div>

<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<script>
const API = document.querySelector('meta[name=gold-api]').content.replace(/\/$/, '');
let token = localStorage.getItem('gr_token') || '';

const loginCard = document.getElementById('loginCard');
const logoutBtn = document.getElementById('logoutBtn');

function setAuthUI() {
  if (!token) {
    loginCard.classList.remove('hidden');
  } else {
    loginCard.classList.add('hidden');
  }
}
setAuthUI();

document.getElementById('loginBtn')?.addEventListener('click', async () => {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const r = await fetch(API + '/api/auth/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, password }) });
  const data = await r.json();
  if (data.token) {
    token = data.token;
    localStorage.setItem('gr_token', token);
    setAuthUI();
    loadPosts(); loadUsers();
  } else {
    alert(data.error || 'Login failed');
  }
});

logoutBtn.addEventListener('click', () => {
  token = '';
  localStorage.removeItem('gr_token');
  setAuthUI();
});

const quill = new Quill('#quill', { theme: 'snow' });

// Preview image
document.getElementById('p-image-file').addEventListener('change', (e) => {
  const file = e.target.files[0];
  const box = document.getElementById('imgPreview');
  if (!file) { box.textContent = 'Preview'; return; }
  const reader = new FileReader();
  reader.onload = () => {
    box.innerHTML = '<img src=\"' + reader.result + '\" class=\"w-full h-full object-cover rounded-lg\">';
  };
  reader.readAsDataURL(file);
});

async function uploadFile(file) {
  const fd = new FormData();
  fd.append('file', file);
  const r = await fetch(API + '/api/uploads', { method:'POST', headers:{ 'Authorization': 'Bearer ' + token }, body: fd });
  const data = await r.json();
  if (!r.ok) throw new Error(data.error || 'Upload failed');
  return data.fileId;
}

document.getElementById('savePost').addEventListener('click', async () => {
  const type = document.getElementById('p-type').value;
  const title = document.getElementById('p-title').value.trim();
  const excerpt = document.getElementById('p-excerpt').value.trim();
  const published = document.getElementById('p-published').checked; // if not ticked -> draft (false)
  const delta = quill.getContents();
  const content = JSON.stringify(delta);

  let coverImageId = null;
  const file = document.getElementById('p-image-file').files[0];
  if (file) {
    coverImageId = await uploadFile(file);
  }

  const r = await fetch(API + '/api/posts', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', 'Authorization': 'Bearer ' + token },
    body: JSON.stringify({ type, title, excerpt, content, coverImageId, published })
  });
  const data = await r.json();
  if (!r.ok) { alert(data.error || 'Save failed'); return; }
  alert('Saved!');
  loadPosts();
});

document.getElementById('createUser').addEventListener('click', async () => {
  const name = document.getElementById('u-name').value.trim();
  const email = document.getElementById('u-email').value.trim();
  const password = document.getElementById('u-password').value;
  const r = await fetch(API + '/api/auth/users', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', 'Authorization': 'Bearer ' + token },
    body: JSON.stringify({ name, email, password })
  });
  const data = await r.json();
  if (!r.ok) { alert(data.error || 'Create failed'); return; }
  alert('User created');
  loadUsers();
});

async function loadPosts() {
  const r = await fetch(API + '/api/posts/all', { headers:{ 'Authorization': 'Bearer ' + token } });
  const rows = await r.json();
  const tbody = document.getElementById('postsTbody');
  tbody.innerHTML = '';
  rows.forEach(p => {
    const tr = document.createElement('tr');
    tr.className = 'border-b';
    const status = p.published ? 'Published' : 'Draft';
    const created = new Date(p.createdAt).toLocaleString();
    tr.innerHTML = `
      <td class="py-2 pr-3">${p.title}</td>
      <td class="py-2 pr-3">${p.type}</td>
      <td class="py-2 pr-3">${status}</td>
      <td class="py-2 pr-3">${created}</td>
    `;
    tbody.appendChild(tr);
  });
}

async function loadUsers() {
  // basic list via /api/auth/me not available; typically you'd have /api/users
  // For parity, we'll just show current user payload if no list endpoint exists.
  const tbody = document.getElementById('usersTbody');
  tbody.innerHTML = '';
  try {
    const r = await fetch(API + '/api/auth/me', { headers:{ 'Authorization': 'Bearer ' + token } });
    const data = await r.json();
    if (data && data.user) {
      const tr = document.createElement('tr');
      tr.className = 'border-b';
      tr.innerHTML = `
        <td class="py-2 pr-3">${data.user.name || '-'}</td>
        <td class="py-2 pr-3">${data.user.email || '-'}</td>
        <td class="py-2 pr-3">${data.user.role || '-'}</td>
        <td class="py-2 pr-3">-</td>
      `;
      tbody.appendChild(tr);
    }
  } catch (e) {
    // ignore
  }
}

document.getElementById('refreshPosts').addEventListener('click', loadPosts);
document.getElementById('refreshUsers').addEventListener('click', loadUsers);

if (token) { loadPosts(); loadUsers(); }
</script>
</body>
</html>
